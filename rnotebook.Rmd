---
title: "670 Project - Happiness in the Time of Covid"
output: html_notebook
---
HOW TO: (can delete this later once we get the hang of it)

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

### Begin Project Stuff 

The three Kaggle datasets we used are at the following URLS:
https://www.kaggle.com/tunguz/data-on-covid19-coronavirus?select=owid-covid-data.csv
https://www.kaggle.com/ajaypalsinghlo/world-happiness-report-2021
https://www.kaggle.com/unsdsn/world-happiness

Load the libraries we need for the project:
```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
#install.packages('gtools')
library(gtools)
#library(readr)
```

Load the datasets:


```{r}
happiness_2015 <- read.csv("data/2015.csv",header=T,na.strings="?")
happiness_2016 <- read.csv("data/2016.csv",header=T,na.strings="?")
happiness_2017 <- read.csv("data/2017.csv",header=T,na.strings="?")
happiness_2018 <- read.csv("data/2018.csv",header=T,na.strings="?")
happiness_2019 <- read.csv("data/2019.csv",header=T,na.strings="?")
happiness_2021 <- read.csv("data/world-happiness-report-2021.csv",header=T,na.strings="?")

covid2020 <- read.csv("data/owid-covid-data.csv",header=T,na.strings="?")
covid2020_filtered <- read.csv("data/covid2020-filtered.csv", header = T, na.strings = "?")
# covid2020_filtered <- read_excel("Documents/2021spring/670 Data Science/project/covid2020-filtered.xlsx")
```


```{r}

```

Manually, once we loaded in the data we noticed many column name mismatches and had to rename quite a few (for example, "Country" vs "Country or Region" or "Score" vs. "Happiness Score" we started doing this programatically but it was pretty tedious code to write and look at so we wanted to take it out of the notebook, we left one example, changing the country column name just as an example )
```{r}
dim(happiness_2015)
names(happiness_2015)
dim(happiness_2016)
names(happiness_2016)
dim(happiness_2017)
names(happiness_2017)
dim(happiness_2018)
names(happiness_2018)
dim(happiness_2019)
names(happiness_2019)
```

### Rename "Country.or.region" to "Country" in 2018/2019 so we can join with the rest.
```{r}
colnames(happiness_2018)[2] <- "Country"
names(happiness_2018)
colnames(happiness_2019)[2] <- "Country"
names(happiness_2019)

happiness_2015 = subset(happiness_2015, select=-c(Region,Standard.Error,Dystopia.Residual))
happiness_2016 = subset(happiness_2016,select=-c(Region,Lower.Confidence.Interval,Upper.Confidence.Interval,Dystopia.Residual))
happiness_2017 = subset(happiness_2017, select=-c(Whisker.high,Whisker.low,Dystopia.Residual))
```
### Add a "Year" Column to each to keep track before merging.
```{r}
happiness_2015$Year=2015
happiness_2016$Year=2016
happiness_2017$Year=2017
happiness_2018$Year=2018
happiness_2019$Year=2019
```


```{r}
# Combine 2015-2019 happiness data into one dataframe
happiness = smartbind(happiness_2015, happiness_2016, happiness_2017, happiness_2018, happiness_2019)
dim(happiness)
names(happiness)
```
```{r}
names(covid2020)
```


```{r}
# check linear statistical significance of all predictors in response to happiness score. 
lm.score.1 = lm(Happiness.Score~ GDP.per.capita + Social.support + Healthy.life.expectancy + Freedom + Generosity + Perceptions.of.corruption, data = happiness)
summary(lm.score.1)
# plot predictions and residuals
plot(predict(lm.score.1), residuals(lm.score.1))
```
```{r}
# check linear statistical significance of all predictors in response to happiness rank. 
lm.rank = lm(Happiness.Rank~ GDP.per.capita + Social.support + Healthy.life.expectancy + Freedom + Generosity + Perceptions.of.corruption, data = happiness)
summary(lm.rank)
# plot predictions and residuals
plot(predict(lm.rank), residuals(lm.rank))
```

```{r}
# fit a linear model with significant predictors in response to happiness score. 
lm.score.2 = lm(Happiness.Score~ GDP.per.capita + Social.support + Healthy.life.expectancy + Freedom, data = happiness)
summary(lm.score.2)
# plot predictions and residuals
plot(predict(lm.score.2), residuals(lm.score.2))


# fit a linear model with significant predictors in response to happiness rank. 
lm.rank.2 = lm(Happiness.Rank~ GDP.per.capita + Social.support + Healthy.life.expectancy + Freedom, data = happiness)
summary(lm.rank.2)
# plot predictions and residuals
plot(predict(lm.rank.2), residuals(lm.rank.2))
```
Results of linear model: 
1. Generosity and Perceptions of corruption are the least significant predictors.
2. The plot of lm.rank is the opposite of lm.score.1.
3. By removing generosity and perceptions of corruption, we get similar R-squared values but a higher F-statistics.


```{r}
# fit a linear model with GDP.per.capita in response to happiness score using K-fold cross validation.
library(boot)
set.seed(1)
cv.error.10 = rep(0:10)
glm.score = glm(Happiness.Score~GDP.per.capita, data = happiness)
cv.error.10 =cv.glm(happiness, glm.score, K=10)
cv.error.10$delta
```


```{r}
# fit a linear model with Freedom in response to happiness score using K-fold cross validation.
glm.score.free = glm(Happiness.Score~Freedom, data = happiness)
cv.error.10.free =cv.glm(happiness, glm.score.free, K=10)
cv.error.10.free$delta
```




```{r}
set.seed(8)
# fit a linear model with multiple predictors in response to happiness score using K-fold cross validation.
glm.score.multi = glm(Happiness.Score ~ GDP.per.capita +  Healthy.life.expectancy + Freedom, data = happiness)
cv.error.5.multi =cv.glm(happiness, glm.score.multi, K=5)
#cv.error = cv.glm(happiness, glm.score.multi, K=5)
cv.error.5.multi
```
```{r}
names(covid2020_filtered)
p <- ggplot(covid2020_filtered, aes(gdp_per_capita, total_deaths)) 
p + geom_point()
p + geom_point() + scale_x_continuous(trans='log2') +
  scale_y_continuous(trans='log2')

```
```{r}
p + geom_bin2d() + scale_fill_gradient(low="green", high="red")
```
```{r}
dp <- ggplot(covid2020_filtered, aes(total_cases, total_deaths, colour = continent)) 
dp + geom_point()
```

```{r}
# merge happiness 2021 table with covid 2020 table using inner join
happy.covid <- happiness_2021 %>% inner_join(covid2020_filtered, by = c("Country.name" = "location"))

summary(happy.covid)
```
<<<<<<< HEAD
```{r}
cp <- ggplot(happy.covid, aes(total_deaths, Ladder.score)) 
cp + geom_point()
```
```{r}
#newdata <- mydata[ which(mydata$gender=='F'& mydata$age > 65), ]
#happiness_na <- happiness[which(happiness$Country=='Canada')]
happiness_na <- subset(happiness, Country == "Canada" | Country == "United States" | Country =="Mexico",
select=c(Country, Year, Happiness.Score, Happiness.Rank))
lp <- ggplot(happiness_na, aes(Year, Happiness.Score, group=Country)) + geom_line(aes(color=Country))
lp
llp <- ggplot(happiness_na, aes(Year, Happiness.Rank, group=Country)) + geom_line(aes(color=Country))
llp
```
=======


```{r}
attach(happy.covid)
# fit a linear model with happiness 2021 data only featuring significant predictors in response to happiness score.
lm.score.wo.covid = lm(Ladder.score ~ Logged.GDP.per.capita + Social.support + Healthy.life.expectancy+ Freedom.to.make.life.choices + Generosity + Perceptions.of.corruption, data=happy.covid)
summary(lm.score.wo.covid)


# fit a linear model with both happiness and covid data with significant predictors in response to happiness score.
lm.score.w.covid = lm(Ladder.score ~ Logged.GDP.per.capita + Social.support + Healthy.life.expectancy+ Freedom.to.make.life.choices + Generosity + Perceptions.of.corruption + total_cases + total_deaths, data=happy.covid)
summary(lm.score.w.covid)
```

Results from the above two models:
Total covid cases and total deaths don't seem to affect the happiniess (Ladder) score much.

```{r}
# predict happiness scores of 2021 using the models trained on previous years' data
data.2021 <- data.frame(GDP.per.capita=Logged.GDP.per.capita, Social.support = Social.support, Healthy.life.expectancy = Healthy.life.expectancy, Freedom=Freedom.to.make.life.choices)
pred.score = predict(lm.score.2, data.2021)
happy.covid$pred.score = pred.score

summary(happy.covid[, 'pred.score'])

pred.country.score <- happy.covid[, c("Country.name", "pred.score")]
pred.rank = pred.country.score[order(-pred.score),]
pred.rank
```
>>>>>>> dabc70adf4da2ef7e68a0ed8f141bd2c516a9a1b
